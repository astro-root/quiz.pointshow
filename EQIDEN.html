<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>EQIDEN</title>
  <style>
    body { background: #111; color: #eee; font-family: sans-serif; padding: 20px; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    form { background: #222; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
    .field-group { margin-bottom: 12px; display: grid; grid-template-columns: repeat(2,1fr); gap: 10px; }
    .field-group label { display: flex; flex-direction: column; font-size: 0.9em; }
    .field-group input[type="number"] { padding: 6px; border: none; border-radius: 4px; box-sizing: border-box; width: 100%; }
    button { margin: 4px; padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; }
    .reset-all { background: #e44; color: #fff; }
    button.mark-correct { background: #2a6; color: #111; }
    button.mark-wrong { background: #a22; color: #fff; }
    button.undo { background: #888; color: #000; }
    button.global-skip { background: #666; color: #fff; }
    button.global-undo { background: #555; color: #fff; }
    #preview { display: flex; flex-direction: column; gap: 20px; }

    .team-row {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      justify-content: center;
    }

    .team-board {
      background: #222;
      border: 2px solid #444;
      padding: 10px;
      flex: 0 0 15%;
      display: flex;
      flex-direction: column;
    }

    .team-board.disqualified { border-color: #a00; opacity: 0.6; }
    .team-name-input { background: #fff; color: #000; padding: 6px; border-radius: 4px; font-weight: bold; text-align: center; margin-bottom: 6px; width: calc(100% - 12px); }
    .team-limits { font-size: 0.8em; color: #ccc; text-align: center; margin-bottom: 8px; }
    .team15-count { color: #f66; }
    .team-controls { display: flex; justify-content: space-around; margin: 8px 0; }
    .team-controls button { flex: 1; margin: 0 2px; }

    .districts { display: flex; flex-direction: column; gap: 4px; }
    .district { background: #333; padding: 4px; display: flex; justify-content: space-between; align-items: center; }
    .district.done { opacity: 0.5; }
    .player-input { background: #fff; color: #000; padding: 4px; border: none; border-radius: 4px; flex: 1; margin-right: 4px; }
    .count { width: 140px; text-align: right; font-size: 0.8em; }
    #global-summary { font-size: 1em; margin: 0 10px; }
  </style>
</head>
<body>
  <header>
    <h1>EQIDEN</h1>
    <button class="reset-all" id="resetAll">リセット</button>
  </header>

  <form id="configForm">
    <div class="field-group">
      <label>1区の正解数<input type="number" name="need0" min="1" value="1" required></label>
      <label>2区の正解数<input type="number" name="need1" min="1" value="1" required></label>
      <label>3区の正解数<input type="number" name="need2" min="1" value="1" required></label>
      <label>4区の正解数<input type="number" name="need3" min="1" value="2" required></label>
      <label>5区の正解数<input type="number" name="need4" min="1" value="2" required></label>
      <label>6区の正解数<input type="number" name="need5" min="1" value="2" required></label>
      <label>7区の正解数<input type="number" name="need6" min="1" value="2" required></label>
      <label>8区の正解数<input type="number" name="need7" min="1" value="2" required></label>
      <label>9区の正解数<input type="number" name="need8" min="1" value="2" required></label>
      <label>10区の正解数<input type="number" name="need9" min="1" value="2" required></label>
      <label>1〜5区 失格<input type="number" name="c15" min="1" value="4" required></label>
      <label>6〜10区 休み<input type="number" name="m" min="0" value="4" required></label>
    </div>
    <button type="submit">適用</button>
  </form>

  <div id="global-controls">
    <button class="global-skip" id="globalSkip">スルー</button>
    <button class="global-undo" id="globalUndoSkip">↶スルー取消</button>
    <span id="global-summary">問題数: 0</span>
  </div>

  <div id="preview"></div>

  <script>
    let globalSkips = 0;

    document.getElementById('configForm').addEventListener('submit', e => {
      e.preventDefault();
      renderPreview();
    });

    document.getElementById('resetAll').onclick = resetAll;
    document.getElementById('globalSkip').onclick = () => {
      globalSkips++;
      decrementRest(null);
      updateGlobalSummary();
    };
    document.getElementById('globalUndoSkip').onclick = () => {
      if (globalSkips > 0) globalSkips--;
      updateGlobalSummary();
    };

    function renderPreview() {
      const f = document.getElementById('configForm');
      const needs = [...Array(10)].map((_,i)=>+f[`need${i}`].value);
      const c15 = +f.c15.value, m = +f.m.value;
      const container = document.getElementById('preview');
      container.innerHTML = '';

      const topRow = document.createElement('div');
      topRow.className = 'team-row';
      for (let i = 1; i <= 3; i++) topRow.appendChild(createTeamBoard(i, needs, c15, m));

      const bottomRow = document.createElement('div');
      bottomRow.className = 'team-row';
      for (let i = 4; i <= 5; i++) bottomRow.appendChild(createTeamBoard(i, needs, c15, m));

      container.appendChild(topRow);
      container.appendChild(bottomRow);

      attachControls();
      updateGlobalSummary();
    }

    function createTeamBoard(teamNo, needs, c15, m) {
      const board = document.createElement('div');
      board.className = 'team-board';
      board.dataset.history = JSON.stringify([]);
      board.dataset.teamWrongs15 = 0;
      board.dataset.m = m;

      board.innerHTML = `
        <input class="team-name-input" value="チーム${teamNo}">
        <div class="team-limits">1〜5区 ✕<span class="team15-count">0/${c15}</span>回 | 6〜10区 休${m}問</div>
        <div class="team-controls">
          <button class="mark-correct" type="button">正解</button>
          <button class="mark-wrong" type="button">誤答</button>
          <button class="undo" type="button">↶</button>
        </div>
        <div class="districts"></div>`;

      const ds = board.querySelector('.districts');
      needs.forEach((need, idx) => {
        const cell = document.createElement('div');
        cell.className = 'district';
        cell.dataset.corrects = 0;
        cell.dataset.skip = 0;
        cell.dataset.need = need;
        cell.dataset.index = idx;
        cell.innerHTML = idx < 5
          ? `<input class="player-input" value="選手${idx+1}"><div class="count">◯0/${need}</div>`
          : `<input class="player-input" value="選手${idx+1}"><div class="count">◯0/${need} 休0/${m}問</div>`;
        ds.appendChild(cell);
      });

      return board;
    }

    function attachControls() {
      document.querySelectorAll('.team-board').forEach(board => {
        const cells = board.querySelectorAll('.district');
        const correctBtn = board.querySelector('.mark-correct');
        const wrongBtn   = board.querySelector('.mark-wrong');
        const undoBtn    = board.querySelector('.undo');

        correctBtn.onclick = () => teamOp('correct', board, cells);
        wrongBtn.onclick   = () => teamOp('wrong', board, cells);
        undoBtn.onclick    = () => teamOp('undo', board, cells);

        updateBoardControls(board, cells);
      });
    }

    function teamOp(action, board, cells) {
      const history = JSON.parse(board.dataset.history);
      const idx = findCurrentIndex(cells);
      if (idx === -1) return;
      if (idx >= 5 && +cells[idx].dataset.skip > 0) return;

      decrementRest(board);

      if (action === 'correct') {
        cells[idx].dataset.corrects = +cells[idx].dataset.corrects + 1;
        history.push({ type: 'correct', index: idx });
      } else if (action === 'wrong') {
        history.push({ type: 'wrong', index: idx });
        if (idx < 5) {
          let w = +board.dataset.teamWrongs15 + 1;
          board.dataset.teamWrongs15 = w;
          board.querySelector('.team15-count').textContent = `${w}/${document.getElementById('configForm').c15.value}`;
          if (w >= +document.getElementById('configForm').c15.value) board.classList.add('disqualified');
        } else {
          const m = +board.dataset.m;
          cells[idx].dataset.skip = m;
        }
      } else if (action === 'undo') {
        const last = history.pop();
        if (!last) return;
        const undoCell = cells[last.index];
        if (last.type === 'correct') {
          undoCell.dataset.corrects = Math.max(0, +undoCell.dataset.corrects - 1);
        } else if (last.type === 'wrong' && last.index < 5) {
          let w = Math.max(0, +board.dataset.teamWrongs15 - 1);
          board.dataset.teamWrongs15 = w;
          board.querySelector('.team15-count').textContent = `${w}/${document.getElementById('configForm').c15.value}`;
          board.classList.remove('disqualified');
        }
      }

      board.dataset.history = JSON.stringify(history);
      updateCell(cells[idx]);
      updateBoardControls(board, cells);
      updateGlobalSummary();
    }

    function findCurrentIndex(cells) {
      return Array.from(cells).findIndex(cell => +cell.dataset.corrects < +cell.dataset.need);
    }

    function decrementRest(excludeBoard) {
      document.querySelectorAll('.team-board').forEach(board => {
        if (board === excludeBoard) return;
        const cells = board.querySelectorAll('.district');
        cells.forEach(cell => {
          const idx = +cell.dataset.index;
          if (idx >= 5 && +cell.dataset.skip > 0) {
            cell.dataset.skip = +cell.dataset.skip - 1;
            updateCell(cell);
          }
        });
        updateBoardControls(board, cells);
      });
    }

    function updateBoardControls(board, cells) {
      const idx = findCurrentIndex(cells);
      const isResting = idx >= 5 && +cells[idx].dataset.skip > 0;
      board.querySelector('.mark-correct').disabled = isResting;
      board.querySelector('.mark-wrong').disabled   = isResting;
    }

    function updateCell(cell) {
      const c = +cell.dataset.corrects;
      const n = +cell.dataset.need;
      const s = +cell.dataset.skip;
      const idx = +cell.dataset.index;
      const m = +document.getElementById('configForm').m.value;

      if (idx < 5) {
        cell.querySelector('.count').textContent = `◯${c}/${n}`;
      } else {
        cell.querySelector('.count').textContent = `◯${c}/${n} 休${s}/${m}問`;
      }

      cell.classList.toggle('done', c >= n);
    }

    function updateGlobalSummary() {
      document.getElementById('global-summary').textContent = `問題数: ${globalSkips}`;
    }

    function resetAll() {
      if (confirm('本当に全体をリセットしますか？')) {
        globalSkips = 0;
        renderPreview();
      }
    }

    renderPreview();
  </script>
</body>
</html>
