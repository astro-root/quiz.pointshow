<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>EQIDEN</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0b0b0b;
      --panel-top:#003a66;
      --panel-bottom:#002f51;
      --card-bg: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));
      --muted:#9aa7aa;
      --ok:#33a853;
      --warn:#a87b1f;
      --danger:#e84a4a;
      --elim-bg:#06283a;
      --elim-text:#bfc8cc;
      --card-border: rgba(255,255,255,0.04);
      --gap:8px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0;font-family:"Hiragino Kaku Gothic ProN","Meiryo",system-ui,sans-serif;-webkit-font-smoothing:antialiased;}
    body{
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(24,160,176,0.03), transparent 14%),
        linear-gradient(180deg, rgba(255,255,255,0.02), transparent 18%),
        var(--bg);
      color:#eee;
      padding:10px;
      font-size:13px;
    }

    .header{ display:flex; align-items:center; gap:10px; padding:6px 8px; border-radius:6px;
      background: linear-gradient(180deg,var(--panel-top),var(--panel-bottom)); margin-bottom:8px; }
    .logo{ width:36px;height:36px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;color:#fff;}
    h1{ margin:0; font-size:15px; color:#fff; }

    .controls{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:8px;
      padding:8px; border-radius:8px; background: linear-gradient(180deg, rgba(0,0,0,0.06), rgba(0,0,0,0.02));
      border:1px solid var(--card-border); font-weight:800;
    }
    .controls .group { display:flex; gap:6px; align-items:center; color:#fff; font-size:12px; white-space:nowrap; }
    .controls input[type="number"]{ width:56px; padding:4px 6px; border-radius:6px; border:1px solid var(--card-border);
      background:transparent; color:#fff; text-align:center; font-weight:700; font-size:12px; }
    .controls button{ padding:6px 8px; border-radius:6px; border:none; cursor:pointer; font-weight:800; font-size:12px; white-space:nowrap; }

    #applyBtn{ background:#2fa84f; color:#062f07; }
    #resetBtn{ background:#d7263d; color:#fff; }
    #globalSkip, #globalUndo{ background:#8d99a6; color:#fff; }

    .needs { display:flex; gap:6px; align-items:center; flex-wrap:wrap; max-width:520px; }

    .teams-wrap {
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: var(--gap);
      width:100%;
      align-items:start;
    }

    .team-card{
      background: var(--card-bg);
      padding:8px;
      border-radius:8px;
      border:1px solid var(--card-border);
      min-height:150px;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
      overflow:visible;
    }
    .team-card.disqualified { opacity:0.75; border-color: rgba(255,0,0,0.12); }

    .team-name {
      display:block; width:100%; padding:6px 8px; font-size:12px; font-weight:800;
      border-radius:6px; border:none; background:transparent; color:var(--muted); text-align:center; outline:none;
    }
    .team-name:focus{ color:#fff; }

    .team-current {
      font-size:12px; font-weight:900; text-align:center; color:#fff; padding:6px; border-radius:6px;
      border:1px solid rgba(255,255,255,0.02); background: linear-gradient(90deg, rgba(255,255,255,0.01), transparent);
    }

    .limits { font-size:11px; color:var(--muted); text-align:center; }

    .districts { display:flex; flex-direction:column; gap:6px; margin-top:6px; }
    .district {
      display:flex; align-items:center; gap:8px; padding:6px; border-radius:6px;
      border:1px solid rgba(255,255,255,0.03); background: linear-gradient(180deg, rgba(0,0,0,0.02), transparent);
      font-size:12px;
    }

    /* ここを調整：選手名の幅を小さくして被らないようにする */
    .district .player-input {
      flex: 0 0 78px;            /* 固定幅を小さく設定（78px） */
      max-width: 78px;
      border:none;
      background:transparent;
      color:var(--muted);
      font-weight:800;
      text-align:left;
      outline:none;
      font-size:12px;
      padding:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .district .player-input:focus{ color:#fff; }

    /* カウント欄は右寄せ・固定幅 */
    .district .count { flex:0 0 120px; text-align:right; font-weight:800; color:var(--muted); font-size:11px; }

    .top-controls { display:flex; gap:6px; justify-content:center; margin-top:6px; }
    .btn { padding:6px 8px; border-radius:6px; border:none; cursor:pointer; font-weight:800; color:#fff; font-size:12px; }
    .btn-correct { background:#2fa84f; color:#062f07; }
    .btn-wrong   { background:#e84a4a; color:#fff; }
    .btn-undo    { background:#8d99a6; color:#fff; }

    .district.reach { background: rgba(168,120,40,0.06); border-color: rgba(168,120,40,0.12); }
    .district.ban-reach { background: rgba(160,60,60,0.06); border-color: rgba(160,60,60,0.12); }
    .district.lock { background: linear-gradient(90deg, rgba(2,24,34,0.6), rgba(6,40,58,0.6)); color:var(--elim-text); }
    .district.lock .player-input { color: var(--elim-text); }
    .district.lock .count { color: var(--elim-text); }

    @media (max-width:1100px){
      body{ font-size:12px; }
      .district .count{ flex-basis:90px; font-size:10px; }
      .team-card{ min-height:140px; padding:6px; }
      .district .player-input { flex-basis:64px; max-width:64px; } /* モバイル時はさらに小さく */
    }
    @media (max-width:720px){
      .teams-wrap { grid-template-columns: repeat(5, minmax(0, 1fr)); grid-auto-rows: auto; gap:6px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">EQ</div>
    <h1>EQIDEN</h1>
  </div>

  <div class="controls" role="region" aria-label="controls">
    <div class="group">
      <label>往路失格
        <input id="c15" type="number" min="1" value="4">
      </label>
    </div>

    <div class="group">
      <label>復路休み
        <input id="mVal" type="number" min="0" value="4">
      </label>
    </div>

    <div class="group">
      <label>選手数
        <input id="playersPerTeam" type="number" min="1" max="10" value="10">
      </label>
    </div>

    <div class="group" style="min-width:260px;">
      <div style="font-weight:800; color:#fff; font-size:12px; margin-bottom:4px;">正解数</div>
      <div class="needs" id="needsInputs"></div>
    </div>

    <button id="applyBtn">開始</button>
    <button id="resetBtn">リセット</button>
    <button id="globalSkip">スルー</button>
    <button id="globalUndo">スルー取消</button>

    <div style="margin-left:auto; font-weight:800; color:var(--muted); font-size:12px;">
      問題数: <span id="global-summary">0</span>
    </div>
  </div>

  <div class="teams-wrap" id="preview" aria-live="polite"></div>

  <script>
  (function(){
    let globalSkips = 0;
    const preview = document.getElementById('preview');
    const c15El = document.getElementById('c15');
    const mValEl = document.getElementById('mVal');
    const playersPerTeamEl = document.getElementById('playersPerTeam');
    const needsInputsWrap = document.getElementById('needsInputs');
    const applyBtn = document.getElementById('applyBtn');
    const resetBtn = document.getElementById('resetBtn');
    const globalSkipBtn = document.getElementById('globalSkip');
    const globalUndoBtn = document.getElementById('globalUndo');
    const globalSummary = document.getElementById('global-summary');

    function defaultNeeds(){ return [1,1,1,2,2,2,2,2,2,2]; }

    function buildNeedsInputs(){
      needsInputsWrap.innerHTML = '';
      const needs = defaultNeeds();
      for(let i=0;i<10;i++){
        const lbl = document.createElement('label');
        lbl.style.display = 'flex';
        lbl.style.flexDirection = 'column';
        lbl.style.alignItems = 'center';
        lbl.style.fontSize = '11px';
        lbl.style.color = '#fff';
        const span = document.createElement('span');
        span.style.fontSize = '10px';
        span.style.color = 'var(--muted)';
        span.textContent = `${i+1}`;
        const inp = document.createElement('input');
        inp.type = 'number';
        inp.id = 'need' + (i+1);
        inp.min = 1;
        inp.value = needs[i];
        inp.style.width = '44px';
        inp.style.padding = '3px';
        inp.style.borderRadius = '6px';
        inp.style.border = '1px solid rgba(255,255,255,0.04)';
        inp.style.background = 'transparent';
        inp.style.color = '#fff';
        inp.style.fontWeight = '700';
        lbl.appendChild(span);
        lbl.appendChild(inp);
        needsInputsWrap.appendChild(lbl);
      }
    }

    function readNeeds(){
      const arr = [];
      for(let i=1;i<=10;i++){
        const el = document.getElementById('need'+i);
        arr.push(el ? Math.max(1, parseInt(el.value||'1',10)) : 1);
      }
      return arr;
    }

    function renderPreview(){
      const needs = readNeeds();
      const c15 = +c15El.value;
      const m = +mValEl.value;
      const playersPerTeam = Math.max(1, Math.min(10, +playersPerTeamEl.value));
      preview.innerHTML = '';

      for(let t = 1; t <= 5; t++){
        preview.appendChild(createTeamBoard(t, needs, c15, m, playersPerTeam));
      }
      updateGlobalSummary();
    }

    function createTeamBoard(teamNo, needs, c15, m, playersPerTeam){
      const board = document.createElement('div');
      board.className = 'team-card';
      board.dataset.history = JSON.stringify([]);
      board.dataset.teamWrongs15 = 0;
      board.dataset.m = m;

      const nameInput = document.createElement('input');
      nameInput.className = 'team-name';
      nameInput.value = `チーム${teamNo}`;

      const currentDiv = document.createElement('div');
      currentDiv.className = 'team-current';
      currentDiv.textContent = '—';

      const limits = document.createElement('div');
      limits.className = 'limits';
      limits.innerHTML = `往路 ×<span class="team15-count">0/${c15}</span>　｜　復路 ${m}問休み`;

      const ctl = document.createElement('div');
      ctl.className = 'top-controls';
      const btnCorrect = document.createElement('button'); btnCorrect.className='btn btn-correct'; btnCorrect.textContent='正解';
      const btnWrong = document.createElement('button'); btnWrong.className='btn btn-wrong'; btnWrong.textContent='誤答';
      const btnUndo = document.createElement('button'); btnUndo.className='btn btn-undo'; btnUndo.textContent='戻る';
      ctl.appendChild(btnCorrect); ctl.appendChild(btnWrong); ctl.appendChild(btnUndo);

      const ds = document.createElement('div'); ds.className = 'districts';
      for(let idx=0; idx<playersPerTeam; idx++){
        const need = needs[idx] !== undefined ? needs[idx] : 1;
        const cell = document.createElement('div');
        cell.className = 'district';
        cell.dataset.corrects = 0;
        cell.dataset.skip = 0;
        cell.dataset.need = need;
        cell.dataset.index = idx;

        const inp = document.createElement('input'); inp.className = 'player-input';
        inp.value = `プレイヤー${idx+1}`;

        const count = document.createElement('div'); count.className = 'count';
        count.textContent = idx < 5 ? `◯0/${need}` : `◯0/${need}　0/${m}問休み`;

        cell.appendChild(inp);
        cell.appendChild(count);
        ds.appendChild(cell);
      }

      board.appendChild(nameInput);
      board.appendChild(currentDiv);
      board.appendChild(limits);
      board.appendChild(ctl);
      board.appendChild(ds);

      btnCorrect.addEventListener('click', ()=> teamOp('correct', board, ds.querySelectorAll('.district')));
      btnWrong.addEventListener('click', ()=> teamOp('wrong', board, ds.querySelectorAll('.district')));
      btnUndo.addEventListener('click', ()=> teamOp('undo', board, ds.querySelectorAll('.district')));

      updateBoardControls(board, ds.querySelectorAll('.district'));
      updateTeamCurrent(board);

      return board;
    }

    function teamOp(action, board, cells){
      const history = JSON.parse(board.dataset.history || '[]');
      const idx = findCurrentIndex(cells);
      if(action !== 'undo'){
        if(idx === -1) return;
        if(idx >= 5 && +cells[idx].dataset.skip > 0) return;
      }

      decrementRest(board);

      if(action === 'correct'){
        history.push({ type:'correct', index: idx });
        cells[idx].dataset.corrects = +cells[idx].dataset.corrects + 1;
      } else if(action === 'wrong'){
        history.push({ type:'wrong', index: idx });
        if(idx < 5){
          board.dataset.teamWrongs15 = (+board.dataset.teamWrongs15 || 0) + 1;
          const c15 = +c15El.value;
          board.querySelector('.team15-count').textContent = `${board.dataset.teamWrongs15}/${c15}`;
          if(+board.dataset.teamWrongs15 >= c15) board.classList.add('disqualified');
        } else {
          const m = +board.dataset.m;
          cells[idx].dataset.skip = m;
        }
      } else if(action === 'undo'){
        const last = history.pop();
        if(!last) return;
        const undoCell = cells[last.index];
        if(last.type === 'correct'){
          undoCell.dataset.corrects = Math.max(0, +undoCell.dataset.corrects - 1);
        } else if(last.type === 'wrong'){
          if(last.index < 5){
            board.dataset.teamWrongs15 = Math.max(0, (+board.dataset.teamWrongs15||0) - 1);
            board.querySelector('.team15-count').textContent = `${board.dataset.teamWrongs15}/${c15El.value}`;
            board.classList.remove('disqualified');
          } else {
            undoCell.dataset.skip = Math.max(0, +undoCell.dataset.skip - 1);
          }
        }
      }

      board.dataset.history = JSON.stringify(history);
      if(idx >= 0) updateCell(cells[idx]);
      updateBoardControls(board, cells);
      updateTeamCurrent(board);
      updateGlobalSummary();
    }

    function findCurrentIndex(cells){
      return Array.from(cells).findIndex(cell => +cell.dataset.corrects < +cell.dataset.need);
    }

    function decrementRest(excludeBoard){
      preview.querySelectorAll('.team-card').forEach(board => {
        if(board === excludeBoard) return;
        const cells = board.querySelectorAll('.district');
        cells.forEach(cell => {
          const idx = +cell.dataset.index;
          if(idx >= 5 && +cell.dataset.skip > 0){
            cell.dataset.skip = Math.max(0, +cell.dataset.skip - 1);
            updateCell(cell);
          }
        });
        updateBoardControls(board, cells);
        updateTeamCurrent(board);
      });
    }

    function updateBoardControls(board, cells){
      const idx = findCurrentIndex(cells);
      const isResting = (idx >= 5 && +cells[idx].dataset.skip > 0);
      const topCorrect = board.querySelector('.btn-correct');
      const topWrong = board.querySelector('.btn-wrong');
      if(topCorrect) topCorrect.disabled = !!isResting;
      if(topWrong) topWrong.disabled = !!isResting;
    }

    function updateCell(cell){
      const c = +cell.dataset.corrects;
      const n = +cell.dataset.need;
      const s = +cell.dataset.skip;
      const idx = +cell.dataset.index;
      const m = +mValEl.value;

      if(idx < 5){
        cell.querySelector('.count').textContent = `◯${c}/${n}`;
      } else {
        cell.querySelector('.count').textContent = `◯${c}/${n} 休${s}/${m}問`;
      }

      cell.classList.toggle('done', c >= n);
      cell.classList.remove('reach','ban-reach','lock');
      if(+cell.dataset.skip > 0){
        cell.classList.add('lock');
      } else if((+cell.dataset.corrects + 1) >= +n){
        cell.classList.add('reach');
      }
    }

    function updateTeamCurrent(board){
      const cells = board.querySelectorAll('.district');
      const idx = findCurrentIndex(cells);
      const currentDiv = board.querySelector('.team-current');
      if(idx === -1){
        currentDiv.textContent = '完了';
        return;
      }
      const cell = cells[idx];
      const playerName = cell.querySelector('.player-input').value || `選手${idx+1}`;
      if(+cell.dataset.skip > 0){
        currentDiv.textContent = `Lock（${playerName}）`;
      } else {
        currentDiv.textContent = `${playerName}`;
      }
    }

    function updateGlobalSummary(){
      globalSummary.textContent = String(globalSkips);
    }

    globalSkipBtn.addEventListener('click', ()=>{
      globalSkips++;
      decrementRest(null);
      updateGlobalSummary();
    });
    globalUndoBtn.addEventListener('click', ()=>{
      if(globalSkips>0) globalSkips--;
      updateGlobalSummary();
    });

    applyBtn.addEventListener('click', e => { e.preventDefault(); renderPreview(); });
    resetBtn.addEventListener('click', ()=> {
      if(!confirm('本当にリセットしますか？')) return;
      globalSkips = 0;
      buildNeedsInputs();
      renderPreview();
    });

    buildNeedsInputs();
    renderPreview();
  })();
  </script>
</body>
</html>
