<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>by</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg: #0b0b0b;
      --header-top: #003a66;
      --header-bottom: #002f51;
      --panel: #072631;
      --ok: #33a853;
      --danger: #d7263d;
      --muted: #9aa7aa;
      --elim-bg: #06283a;
      --elim-text: #bfc8cc;
      --card-shadow: 0 8px 20px rgba(0,0,0,0.6);
      --win-shadow: 0 0 20px gold, 0 0 40px rgba(255,215,0,0.6);
      --correct-blue: #3ea6ff;
      --wrong-red: #ff5b5b;
    }

    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; padding:0; }

    body {
      font-family: "Hiragino Kaku Gothic ProN", "Meiryo", system-ui, sans-serif;
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(24,160,176,0.03), transparent 14%),
        linear-gradient(180deg, rgba(255,255,255,0.02), transparent 18%),
        var(--bg);
      color: #eee;
      padding: 18px;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    .header {
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px 16px;
      border-radius:10px;
      background: linear-gradient(180deg, var(--header-top), var(--header-bottom));
      box-shadow: 0 6px 18px rgba(0,0,0,0.6), inset 0 -2px 0 rgba(255,255,255,0.03);
      margin-bottom:12px;
    }
    .logo { width:48px; height:48px; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:18px; color:#fff; background: linear-gradient(135deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01)); box-shadow: 0 6px 12px rgba(0,0,0,0.6); }
    h1 { margin:0; font-size:20px; color:#fff; }

    /* 設定欄のフォントサイズを連答付きと同じ（大きめ）に */
    .controls {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border-radius:10px;
      background: linear-gradient(180deg, rgba(0,0,0,0.12), rgba(0,0,0,0.04));
      margin-bottom:16px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.5);
    }
    .controls label {
      display:flex;
      gap:8px;
      align-items:center;
      color:#fff;
      font-weight:700;
      font-size:18px; /* 連答付き と同じ */
      padding:8px 10px;
      border-radius:8px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      border: 1px solid rgba(255,255,255,0.02);
    }
    .controls input[type="number"],
    .controls input[type="text"] {
      width:84px;
      padding:6px 8px;
      border-radius:6px;
      border:1px solid rgba(255,255,255,0.04);
      text-align:center;
      background: transparent;
      color: #fff;
      font-weight:700;
      font-size:18px; /* 連答付き と同じ */
    }
    .controls button {
      padding:8px 12px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-weight:800;
      font-size:14px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.45);
    }
    #generateBtn { background: linear-gradient(180deg,var(--ok), #2b8f44); color:#062f07; }
    #resetAllBtn { background: linear-gradient(180deg,var(--danger), #b71b2b); color:#fff; }
    #undoGlobalBtn { background: linear-gradient(180deg,#9e9e9e,#6f6f6f); color:#fff; }

    /* スコアボードグリッド */
    .scoreboard {
      display: grid;
      gap: 14px;
      justify-items: stretch;
      align-items: start;
      width: 100%;
      overflow-x: auto;
      padding-bottom:6px;
    }

    .column {
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));
      padding: 12px;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      text-align: center;
      width: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.03);
      color: #fff;
      min-width: 0;
    }

    .name-input {
      writing-mode: vertical-rl;
      text-orientation: upright;
      border: none;
      background: transparent;
      font-weight:800;
      font-size:24px;
      height:250px;
      width:44px;
      padding:4px;
      margin-bottom:8px;
      text-align:center;
      outline: none;
      color: #fff;
    }

    .points-display {
      font-size:34px;
      font-weight:800;
      color: var(--ok);
      margin-bottom:8px;
      user-select: none;
      transition: transform 0.18s ease;
      min-height:42px;
      display:flex;
      align-items:center;
      justify-content:center;
      width:100%;
    }

    .counts-row {
      display:flex;
      gap:14px;
      justify-content:center;
      align-items:center;
      width:100%;
      margin-bottom:8px;
    }
    .correct-num { color: var(--correct-blue); font-weight:800; font-size:18px; min-width:36px; text-align:center; }
    .wrong-num { color: var(--wrong-red); font-weight:800; font-size:18px; min-width:36px; text-align:center; }

    .buttons {
      display:flex;
      gap:8px;
      width:100%;
      justify-content:center;
      margin-top:6px;
    }

    .btn { flex:1; font-size:14px; padding:8px 6px; border-radius:8px; cursor:pointer; font-weight:800; border:none; }
    .btn-correct { background: linear-gradient(180deg,#2fa84f,#1d7b36); color:#042a08; }
    .btn-wrong   { background: linear-gradient(180deg,#e84a4a,#b71b2b); color:#fff; }

    .status { font-weight:800; font-size:14px; min-height:20px; margin-top:8px; color: #a8e7ff; visibility:hidden; }

    .column.eliminated { background: var(--elim-bg); color: var(--elim-text); box-shadow: none; }
    .column.eliminated .name-input { color: var(--elim-text); }
    .column.eliminated .points-display { color: var(--elim-text); }
    .column.eliminated .counts-row { color: var(--elim-text); opacity:0.95; }
    .column.eliminated .btn { opacity:0.6; cursor:not-allowed; }

    .column.win { box-shadow: var(--win-shadow); }

    .points-display.animate { animation: pop 0.28s ease; }
    @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.22); } 100% { transform: scale(1); } }

    @media (max-width:720px){
      .column { padding:10px; }
      .name-input { height:86px; width:36px; font-size:16px; }
      .points-display { font-size:26px; min-height:36px; }
      .counts-row { gap:8px; }
      .correct-num, .wrong-num { font-size:16px; min-width:28px; }
      .controls { gap:8px; padding:8px; }
      .controls label { font-size:16px; padding:6px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">BY</div>
    <h1>by</h1>
  </div>

  <div class="controls">
    <label>参加人数:
      <input type="number" id="playerCount" min="2" max="12" value="6" />
    </label>

    <label>勝ち抜け:
      <input type="number" id="mValue" min="1" value="5" />
    </label>

    <label>失格:
      <input type="number" id="maxWrong" min="1" value="2" />
    </label>

    <button id="generateBtn">開始</button>
    <button id="resetAllBtn">リセット</button>
    <button id="undoGlobalBtn">戻る</button>
  </div>

  <div class="scoreboard" id="scoreboard" aria-label="scoreboard"></div>

  <script>
    const scoreboard = document.getElementById("scoreboard");
    const mInput = document.getElementById("mValue");
    const playerCountInput = document.getElementById("playerCount");
    const maxWrongInput = document.getElementById("maxWrong");
    const resetAllBtn = document.getElementById("resetAllBtn");
    const generateBtn = document.getElementById("generateBtn");
    const undoGlobalBtn = document.getElementById("undoGlobalBtn");

    let players = [];      // 各プレイヤー状態オブジェクト配列
    let historyStack = []; // グローバル操作履歴（{type:'correct'|'wrong', idx}）
    let winners = [];      // 抜け順 idx 配列（順位割り当て用）
    const MIN_COL_PX = 110; // 1列の最小幅（px）

    function animatePoints(el){
      if(!el) return;
      el.classList.add("animate");
      setTimeout(()=>el.classList.remove("animate"), 300);
    }

    function setGridColumnsByCount(count){
      const gapTotal = 14 * (Math.max(0, count - 1));
      const containerWidth = Math.max(0, scoreboard.clientWidth - 2);
      const idealCol = Math.floor((containerWidth - gapTotal) / count);
      if(idealCol >= MIN_COL_PX){
        scoreboard.style.gridTemplateColumns = `repeat(${count}, 1fr)`;
        scoreboard.style.overflowX = 'hidden';
      } else {
        scoreboard.style.gridTemplateColumns = `repeat(${count}, minmax(${MIN_COL_PX}px, 1fr))`;
        scoreboard.style.overflowX = 'auto';
      }
    }

    function ordinalLabel(n){
      if(n % 100 >= 11 && n % 100 <= 13) return n + 'th';
      const last = n % 10;
      if(last === 1) return n + 'st';
      if(last === 2) return n + 'nd';
      if(last === 3) return n + 'rd';
      return n + 'th';
    }

    function createScoreboard(count){
      scoreboard.innerHTML = "";
      players = [];
      historyStack = [];
      winners = [];
      setGridColumnsByCount(count);

      for(let i=0;i<count;i++){
        const col = document.createElement("div");
        col.className = "column";
        col.innerHTML = `
          <input type="text" class="name-input" placeholder="プレイヤー${i+1}" />
          <div class="points-display">0</div>
          <div class="counts-row">
            <div class="correct-num">0</div>
            <div class="wrong-num">0</div>
          </div>
          <div class="buttons">
            <button class="btn btn-correct">正解</button>
            <button class="btn btn-wrong">誤答</button>
          </div>
          <div class="status"></div>
        `;

        const nameInput = col.querySelector(".name-input");
        const pointsDisplay = col.querySelector(".points-display");
        const correctNum = col.querySelector(".correct-num");
        const wrongNum = col.querySelector(".wrong-num");
        const btnCorrect = col.querySelector(".btn-correct");
        const btnWrong = col.querySelector(".btn-wrong");

        const state = {
          idx: i,
          el: col,
          nameInput,
          pointsDisplay,
          correctNum,
          wrongNum,
          btnCorrect,
          btnWrong,
          correct: 0,
          wrong: 0,
          points: 0,
          eliminated: false,
          rank: 0
        };

        // ボタン動作：操作履歴を残してから値を変える
        btnCorrect.addEventListener("click", ()=>{
          if(state.eliminated) return;
          historyStack.push({ type:'correct', idx: state.idx });
          state.correct++;
          updateAllDisplays(true);
        });

        btnWrong.addEventListener("click", ()=>{
          if(state.eliminated) return;
          historyStack.push({ type:'wrong', idx: state.idx });
          state.wrong++;
          updateAllDisplays(true);
        });

        players.push(state);
        scoreboard.appendChild(col);
      }

      updateAllDisplays(false);
      updateUndoButton();
    }

    // すべての表示を更新（順位の割り当て／解除もここで管理）
    function updateAllDisplays(animate=true){
      const m = Math.max(1, parseInt(mInput.value || 1));
      const maxWrong = Math.max(1, parseInt(maxWrongInput.value || 1));
      const winThreshold = m * m;

      // 先に各プレイヤーの points/eliminated を計算（まだ順位は変更しない）
      players.forEach(p => {
        p.points = p.correct * Math.max(0, m - p.wrong);
        // eliminated は誤答数による判定（設定欄）
        p.eliminated = p.wrong >= maxWrong;
      });

      // 順位割り当て（到達した順に winners に追加）
      players.forEach(p => {
        if(!p.eliminated && p.rank === 0 && p.points >= winThreshold){
          // 到達したタイミングで追加
          winners.push(p.idx);
          p.rank = winners.length;
        }
      });

      // 順位取り消し：もし既に順位が付いているプレイヤーが閾値未満になったら取り除く
      players.forEach(p => {
        if(p.rank > 0 && p.points < winThreshold){
          const pos = winners.indexOf(p.idx);
          if(pos !== -1) winners.splice(pos,1);
          p.rank = 0;
        }
      });
      // winners の順序に従って rank を再割り当て
      winners.forEach((idx, i) => {
        const pp = players[idx];
        if(pp) pp.rank = i + 1;
      });

      // 表示の反映
      players.forEach(p => {
        // eliminated -> points に "Lose"
        if(p.eliminated){
          p.el.classList.add("eliminated");
          p.pointsDisplay.textContent = "Lose";
          p.correctNum.textContent = String(p.correct);
          p.wrongNum.textContent = String(p.wrong);
          p.btnCorrect.disabled = true;
          p.btnWrong.disabled = true;
          p.nameInput.disabled = true;
          // 削除：順位バッジが残っていたら消す
          const badge = p.pointsDisplay.querySelector('.rank-badge');
          if(badge) badge.remove();
        } else {
          p.el.classList.remove("eliminated");
          p.pointsDisplay.textContent = String(p.points);
          p.correctNum.textContent = String(p.correct);
          p.wrongNum.textContent = String(p.wrong);
          p.btnCorrect.disabled = false;
          p.btnWrong.disabled = false;
          p.nameInput.disabled = false;

          // 順位バッジの表示（rank が 0 なら消す）
          let badge = p.pointsDisplay.querySelector('.rank-badge');
          if(p.rank > 0){
            if(!badge){
              badge = document.createElement('span');
              badge.className = 'rank-badge';
              badge.style.position = 'absolute';
              badge.style.left = '8px';
              badge.style.top = '-8px';
              badge.style.background = 'var(--correct-blue)';
              badge.style.color = '#01263b';
              badge.style.padding = '6px 8px';
              badge.style.borderRadius = '8px';
              badge.style.fontWeight = '900';
              badge.style.fontSize = '12px';
              p.pointsDisplay.appendChild(badge);
            }
            badge.textContent = ordinalLabel(p.rank);
          } else {
            if(badge) badge.remove();
          }
        }

        if(animate) animatePoints(p.pointsDisplay);
      });

      updateUndoButton();
    }

    function undoLast(){
      if(historyStack.length === 0) return;
      const last = historyStack.pop();
      if(!last) return;
      const p = players[last.idx];
      if(!p) return;
      if(last.type === 'correct') p.correct = Math.max(0, p.correct - 1);
      else if(last.type === 'wrong') p.wrong = Math.max(0, p.wrong - 1);
      // points / rank / eliminated は updateAllDisplays に委ねる
      updateAllDisplays(true);
    }

    function updateUndoButton(){
      undoGlobalBtn.disabled = historyStack.length === 0;
    }

    function resetAll(){
      players.forEach((p, i) => {
        p.correct = 0;
        p.wrong = 0;
        p.points = 0;
        p.eliminated = false;
        p.rank = 0;
        p.nameInput.value = "";
        p.btnCorrect.disabled = false;
        p.btnWrong.disabled = false;
        p.nameInput.disabled = false;
        p.el.classList.remove("win", "eliminated");
        const badge = p.pointsDisplay.querySelector('.rank-badge');
        if(badge) badge.remove();
      });
      historyStack = [];
      winners = [];
      updateAllDisplays(true);
    }

    generateBtn.addEventListener("click", ()=>{
      const count = Math.max(2, Math.min(12, parseInt(playerCountInput.value || 6)));
      createScoreboard(count);
    });

    resetAllBtn.addEventListener("click", resetAll);
    undoGlobalBtn.addEventListener("click", undoLast);
    mInput.addEventListener("input", ()=> updateAllDisplays(false));
    maxWrongInput.addEventListener("input", ()=> updateAllDisplays(false));

    // 初期生成（参加人数デフォルト 6）
    createScoreboard(Math.max(2, Math.min(12, parseInt(playerCountInput.value || 6))));

    // ウィンドウリサイズで列幅を再計算
    window.addEventListener("resize", ()=>{
      const count = players.length || Math.max(2, Math.min(12, parseInt(playerCountInput.value || 6)));
      setGridColumnsByCount(count);
    });

    // playerCount の変更で幅だけ調整（カード数を変えるには「作成」押下）
    playerCountInput.addEventListener("input", ()=>{
      const count = Math.max(2, Math.min(12, parseInt(playerCountInput.value || 6)));
      setGridColumnsByCount(count);
    });
  </script>
</body>
</html>
