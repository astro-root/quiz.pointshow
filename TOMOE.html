<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>TOMOE</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 20px; font-size: 16px; }
    h1 { font-size: 32px; margin-bottom: 20px; }
    .settings { margin-bottom: 25px; }
    .settings input, .settings button { font-size: 18px; padding: 5px 10px; }
    .controls { margin-bottom: 20px; }
    .controls button { font-size: 18px; padding: 6px 12px; margin-right: 10px; }
    .controls .question-count { font-size: 32px; font-weight: bold; vertical-align: middle; margin-left: 10px; }
    .teams { display: flex; justify-content: space-around; gap: 30px; }
    .team { border: 2px solid #333; padding: 15px; width: 350px; }
    .team.winner { background-color: #c8facc; }
    .team h2 { margin: 0 0 15px; border-bottom: 1px solid #333; padding-bottom: 5px; font-size: 20px; }
    .team .product { font-size: 64px; margin: 15px 0; font-weight: bold; }
    .member-table { width: 100%; border-collapse: collapse; font-size: 16px; margin-top: 10px; }
    .member-table th, .member-table td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    .member-table th { background-color: #f0f0f0; }
    .no-rights { opacity: 0.3; }
    .can-win { background-color: #ffeb3b; }
    .name-cell input { width: 90%; border: none; text-align: center; font-size: 16px; padding: 4px; }
    .btn-cell button { margin: 4px; font-size: 18px; padding: 4px 8px; }
  </style>
</head>
<body>
  <h1>TOMOE</h1>
  <div class="settings">
    勝ち抜け <input type="number" id="mInput" value="25" min="1">  
    限定問題数 <input type="number" id="nInput" value="30" min="1">  
    <button id="resetAllBtn">リセット</button>
  </div>
  <div class="controls">
    <button onclick="skipQuestion()">スルー</button>
    問題数 <span id="questionCount" class="question-count">0</span>
  </div>
  <div class="teams" id="teams"></div>
  <script>
    const teamData = [
      { name: 'チーム1', members: [
          { position: 'β', name: 'A', point: 0, active: true },
          { position: 'β', name: 'B', point: 0, active: true },
          { position: 'α', name: 'C', point: 0, active: true }
        ], winner: false },
      { name: 'チーム2', members: [
          { position: 'β', name: 'D', point: 0, active: true },
          { position: 'β', name: 'E', point: 0, active: true },
          { position: 'α', name: 'F', point: 0, active: true }
        ], winner: false }
    ];
    let questionCount = 0;

    function renderTeams() {
      const container = document.getElementById('teams');
      container.innerHTML = '';
      const thresh = +document.getElementById('mInput').value;

      teamData.forEach((team, tIdx) => {
        // 各ポジションに初期点1を加算
        const betaSum = team.members.filter(m => m.position === 'β').reduce((s, m) => s + m.point, 0) + 1;
        const alphaSum = team.members.filter(m => m.position === 'α').reduce((s, m) => s + m.point, 0) + 1;
        const prod = betaSum * alphaSum;

        const div = document.createElement('div');
        div.className = 'team' + (team.winner ? ' winner' : '');

        // チーム名
        const title = document.createElement('h2');
        const nameInput = document.createElement('input');
        nameInput.value = team.name;
        nameInput.style.fontSize = '18px';
        nameInput.oninput = e => { team.name = e.target.value; renderTeams(); };
        title.appendChild(nameInput);
        div.appendChild(title);

        // 積表示
        const pd = document.createElement('div'); pd.className = 'product'; pd.textContent = prod; div.appendChild(pd);

        // メンバーテーブル
        const tbl = document.createElement('table'); tbl.className = 'member-table';

        // ヘッダ行1: β (colspan=2), α (colspan=1)
        const header1 = document.createElement('tr');
        const thBeta = document.createElement('th'); thBeta.colSpan = 2; thBeta.textContent = 'β'; header1.appendChild(thBeta);
        const thAlpha = document.createElement('th'); thAlpha.colSpan = 1; thAlpha.textContent = 'α'; header1.appendChild(thAlpha);
        tbl.appendChild(header1);

        // ヘッダ行2: β得点, α得点
        const header2 = document.createElement('tr');
        const thBetaScore = document.createElement('th'); thBetaScore.colSpan = 2; thBetaScore.textContent = betaSum; header2.appendChild(thBetaScore);
        const thAlphaScore = document.createElement('th'); thAlphaScore.colSpan = 1; thAlphaScore.textContent = alphaSum; header2.appendChild(thAlphaScore);
        tbl.appendChild(header2);

        // 名前行: 各プレイヤー
        const rowNames = document.createElement('tr');
        team.members.forEach((m, idx) => {
          const td = document.createElement('td'); td.className = 'name-cell';
          if (!m.active) td.classList.add('no-rights');
          // あと1問で勝ち抜け可能か
          let newBeta = betaSum + (m.position === 'β' && m.active ? 1 : 0);
          let newAlpha = alphaSum + (m.position === 'α' && m.active ? 1 : 0);
          if (m.active && newBeta * newAlpha >= thresh) td.classList.add('can-win');

          const inp = document.createElement('input'); inp.value = m.name;
          inp.style.fontSize = '16px';
          inp.oninput = e => { m.name = e.target.value; };
          td.appendChild(inp);
          rowNames.appendChild(td);
        });
        tbl.appendChild(rowNames);

        // ボタン行: 各プレイヤー
        const rowBtns = document.createElement('tr');
        team.members.forEach((m, idx) => {
          const td = document.createElement('td'); td.className = 'btn-cell';
          if (!m.active) td.classList.add('no-rights');
          // あと1問で勝ち抜け可能か
          let newBeta = betaSum + (m.position === 'β' && m.active ? 1 : 0);
          let newAlpha = alphaSum + (m.position === 'α' && m.active ? 1 : 0);
          if (m.active && newBeta * newAlpha >= thresh) td.classList.add('can-win');

          const ok = document.createElement('button'); ok.textContent = '正解'; ok.onclick = () => handleCorrect(tIdx, idx);
          const ng = document.createElement('button'); ng.textContent = '誤答'; ng.onclick = () => handleWrong(tIdx, idx);
          td.append(ok, ng);
          rowBtns.appendChild(td);
        });
        tbl.appendChild(rowBtns);

        div.appendChild(tbl);
        container.appendChild(div);
      });
    }

    function handleCorrect(teamIdx, memberIdx) {
      // 問題数を増やす
      questionCount++;
      document.getElementById('questionCount').textContent = questionCount;

      const m = teamData[teamIdx].members[memberIdx]; if (!m.active) return;
      m.point++;
      teamData.forEach(tm => tm.members.forEach(x => x.active = true));
      checkVictory();
    }

    function handleWrong(teamIdx, memberIdx) {
      // 問題数を増やす
      questionCount++;
      document.getElementById('questionCount').textContent = questionCount;

      teamData[teamIdx].members[memberIdx].active = false;
      checkVictory();
    }

    function skipQuestion() {
      questionCount++;
      document.getElementById('questionCount').textContent = questionCount;
      teamData.forEach(tm => tm.members.forEach(x => x.active = true));
      checkVictory();
    }

    function checkVictory() {
      const thresh = +document.getElementById('mInput').value;
      teamData.forEach(tm => {
        const b = tm.members.filter(m => m.position === 'β').reduce((s, m) => s + m.point, 0) + 1;
        const a = tm.members.filter(m => m.position === 'α').reduce((s, m) => s + m.point, 0) + 1;
        tm.winner = (b * a >= thresh);
      });
      renderTeams();
    }

    document.getElementById('resetAllBtn').onclick = () => {
      teamData.forEach(tm => tm.members.forEach(x => { x.point = 0; x.active = true; }));
      questionCount = 0;
      document.getElementById('questionCount').textContent = 0;
      teamData.forEach(tm => tm.winner = false);
      renderTeams();
    };

    renderTeams();
  </script>
</body>
</html>
