<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>連答付き</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    :root{
      --bg:#0b0b0b;
      --panel-top:#003a66;
      --panel-bottom:#002f51;
      --card-bg: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));
      --ok:#33a853;
      --muted:#9aa7aa;
      --correct-blue:#3ea6ff;
      --ren-color:#7fe8ff; /* 連答時の水色 */
      --wrong-red:#ff6b6b;
      --elim-bg:#06283a;
      --elim-text:#bfc8cc;
      --rank-bg:#3ea6ff;
      --rank-color:#01263b;
      --card-shadow:0 8px 20px rgba(0,0,0,0.6);
      --win-shadow:0 0 20px gold,0 0 40px rgba(255,215,0,0.6);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0;font-family:"Hiragino Kaku Gothic ProN","Meiryo",system-ui,sans-serif}
    body{
      background:
        radial-gradient(1200px 600px at 10% 10%, rgba(24,160,176,0.03), transparent 14%),
        linear-gradient(180deg, rgba(255,255,255,0.02), transparent 18%),
        var(--bg);
      color:#eee; padding:18px; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    .header{ display:flex; align-items:center; gap:12px; padding:12px 16px; border-radius:10px; background: linear-gradient(180deg,var(--panel-top),var(--panel-bottom)); box-shadow:0 6px 18px rgba(0,0,0,0.6), inset 0 -2px 0 rgba(255,255,255,0.03); margin-bottom:12px; }
    .logo{ width:48px;height:48px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:18px;color:#fff;background:linear-gradient(135deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01)); box-shadow:0 6px 12px rgba(0,0,0,0.6) }
    h1{ margin:0; font-size:20px; color:#fff; }

    .settings{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; padding:10px 12px; border-radius:10px; margin-bottom:18px; background: linear-gradient(180deg, rgba(0,0,0,0.12), rgba(0,0,0,0.04)); box-shadow:0 6px 18px rgba(0,0,0,0.5); }
    .settings label{ display:flex; gap:8px; align-items:center; color:#fff; font-weight:700; padding:8px 10px; border-radius:8px; background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent); border:1px solid rgba(255,255,255,0.02); }
    .settings input[type="number"]{ width:80px; padding:6px 8px; border-radius:6px; border:1px solid rgba(255,255,255,0.04); text-align:center; background:transparent; color:#fff; font-weight:700 }
    .settings button{ padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:800; font-size:14px; box-shadow:0 6px 12px rgba(0,0,0,0.45); }
    #setupBtn{ background: linear-gradient(180deg,var(--ok),#2b8f44); color:#062f07; }
    #resetAll{ background: linear-gradient(180deg,#d7263d,#b71b2b); color:#fff; }
    #undoGlobal{ background: linear-gradient(180deg,#9e9e9e,#6f6f6f); color:#fff; }

    .scoreboard{ display:grid; gap:18px; width:100%; justify-items:stretch; align-items:start; }

    .column{ background: var(--card-bg); padding:16px; border-radius:14px; box-shadow:var(--card-shadow); text-align:center; width:100%; display:flex; flex-direction:column; align-items:center; position:relative; border:1px solid rgba(255,255,255,0.03); color:#fff; min-width:0; }

    .name-input{ writing-mode: vertical-rl; text-orientation: upright; border: none; background: transparent; font-weight:800; font-size:24px; height:250px; width:44px; padding:4px; margin-bottom:8px; text-align:center; color:var(--muted); outline: none; caret-color: #fff; }
    .name-input:focus{ color: #fff; }

    .correct-count{ font-size:48px; margin:8px 0; color:var(--ok); font-weight:900; position:relative; min-height:54px; }
    .correct-count .correct-num{ display:block; }

    /* 連答時の見た目：数字だけ水色に */
    .num-ren{ color:var(--ren-color); font-weight:900; display:inline-block; min-width:18px; text-align:center; }

    .wrong-count{ font-size:20px; color:var(--wrong-red); margin-bottom:10px; font-weight:800; min-height:22px; }

    .buttons{ display:flex; gap:10px; width:100%; justify-content:center; margin-top:8px }
    .btn-op{ flex:1; padding:10px 8px; border-radius:8px; border:none; cursor:pointer; font-weight:800; font-size:16px }
    .btn-correct{ background: linear-gradient(180deg,#2fa84f,#1d7b36); color:#042a08 }
    .btn-wrong{ background: linear-gradient(180deg,#e84a4a,#b71b2b); color:#fff }

    /* 余計な表示は非表示にする */
    .rank-badge, .ren-badge, .status{ display:none !important; }

    .column.eliminated{ background: var(--elim-bg); color: var(--elim-text); box-shadow:none; }
    .column.eliminated .name-input{ color: var(--elim-text); }
    .column.eliminated .correct-count, .column.eliminated .wrong-count { color: var(--elim-text); opacity:0.95; }
    .column.eliminated .btn-op{ opacity:0.6; cursor:not-allowed; }

    .column.finished{ box-shadow: var(--win-shadow); opacity:0.98; }

    .num-animate{ animation: pop 0.28s ease; }
    @keyframes pop{ 0%{ transform: scale(1);} 50%{ transform: scale(1.12);} 100%{ transform: scale(1);} }

    @media (max-width:720px){ .name-input{ height:88px; width:36px; font-size:16px; } .correct-count{ font-size:36px; } .wrong-count{ font-size:18px; } }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">連付</div>
    <h1>連答付き</h1>
  </div>

  <div class="settings">
    <label>勝ち抜け: <input type="number" id="maxCorrectInput" value="5" min="1"></label>
    <label>失格: <input type="number" id="maxWrongInput" value="2" min="1"></label>
    <label>参加人数: <input type="number" id="playerCountInput" value="6" min="1" max="20"></label>
    <button id="setupBtn">開始</button>
    <button id="resetAll">リセット</button>
    <button id="undoGlobal">戻る</button>
  </div>

  <div class="scoreboard" id="scoreboard"></div>

  <script>
    (function(){
      const scoreboard = document.getElementById('scoreboard');
      const setupBtn = document.getElementById('setupBtn');
      const resetAllBtn = document.getElementById('resetAll');
      const undoGlobalBtn = document.getElementById('undoGlobal');
      const maxCorrectInput = document.getElementById('maxCorrectInput');
      const maxWrongInput = document.getElementById('maxWrongInput');
      const playerCountInput = document.getElementById('playerCountInput');

      let players = []; // { el, nameEl, correct, wrong, rank, eliminated, hasRight, btnC, btnW, correctEl, correctNumEl, wrongEl }
      let historyStack = []; // [{ idx, prev: {...}, winners: [...], rights: [...] }]
      let winners = [];

      function buildGrid(count){ scoreboard.style.gridTemplateColumns = `repeat(${count}, 1fr)`; }

      function createPlayerColumn(i){
        const col = document.createElement('div');
        col.className = 'column';
        col.innerHTML = `
          <input class="name-input" type="text" value="プレイヤー${i+1}">
          <div class="correct-count"><span class="correct-num">0</span></div>
          <div class="wrong-count"></div>
          <div class="buttons">
            <button class="btn-op btn-correct">正解</button>
            <button class="btn-op btn-wrong">誤答</button>
          </div>
        `;

        const nameEl = col.querySelector('.name-input');
        const correctEl = col.querySelector('.correct-count');
        const correctNumEl = col.querySelector('.correct-num');
        const wrongEl = col.querySelector('.wrong-count');
        const btnC = col.querySelector('.btn-correct');
        const btnW = col.querySelector('.btn-wrong');

        const state = {
          el: col,
          nameEl,
          correct: 0,
          wrong: 0,
          rank: 0,
          eliminated: false,
          hasRight: false,
          btnC, btnW, correctEl, correctNumEl, wrongEl
        };

        function snapshot(){
          return { correct: state.correct, wrong: state.wrong, rank: state.rank, eliminated: state.eliminated, hasRight: state.hasRight };
        }

        btnC.addEventListener('click', ()=>{
          if(state.rank !== 0 || state.eliminated) return;

          const rightsSnapshot = players.map(p => !!p.hasRight);
          historyStack.push({ idx: i, prev: snapshot(), winners: winners.slice(), rights: rightsSnapshot });

          if(state.hasRight){
            state.correct += 2;
            state.hasRight = false; // 消費
          } else {
            state.correct += 1;
            // その正解で他の人の連答権は消える
            players.forEach(p => p.hasRight = false);
            state.hasRight = true;
          }

          checkFinishAndEliminate(state, i);
          renderAll(true);
        });

        btnW.addEventListener('click', ()=>{
          if(state.rank !== 0 || state.eliminated) return;

          const rightsSnapshot = players.map(p => !!p.hasRight);
          historyStack.push({ idx: i, prev: snapshot(), winners: winners.slice(), rights: rightsSnapshot });

          state.wrong++;
          // 誤答で自分の連答権は消える
          state.hasRight = false;

          checkFinishAndEliminate(state, i);
          renderAll(true);
        });

        return state;
      }

      function checkFinishAndEliminate(state, idx){
        const maxCorrect = Math.max(1, parseInt(maxCorrectInput.value || 1));
        const maxWrong = Math.max(1, parseInt(maxWrongInput.value || 1));

        if(state.rank === 0 && state.correct >= maxCorrect){
          winners.push(idx);
          state.rank = winners.length;
        }
        if(!state.eliminated && state.wrong >= maxWrong){
          state.eliminated = true;
          state.hasRight = false;
        }
      }

      function renderAll(animate = false){
        players.forEach((p, idx) => {
          // 表示ルール：勝ち抜けなら順位（ordinal）を表示、失格なら Lose、通常は点数。連答権があると数字が水色になる。
          if(p.rank > 0){
            p.correctNumEl.innerHTML = escapeHtml(ordinalLabel(p.rank));
          } else if(p.eliminated){
            p.correctNumEl.textContent = 'Lose';
          } else {
            const num = String(p.correct);
            if(p.hasRight){
              // 水色で数字だけ表示
              p.correctNumEl.innerHTML = `<span class="num-ren">${escapeHtml(num)}</span>`;
            } else {
              p.correctNumEl.textContent = num;
            }
          }

          // wrong count as ×
          p.wrongEl.textContent = p.wrong > 0 ? '×'.repeat(p.wrong) : '';

          // 挙動制御
          if(p.eliminated){
            p.el.classList.add('eliminated');
            p.btnC.disabled = true; p.btnW.disabled = true; p.nameEl.disabled = true; p.nameEl.style.color = 'var(--elim-text)';
          } else {
            p.el.classList.remove('eliminated');
            if(p.rank === 0){ p.btnC.disabled = false; p.btnW.disabled = false; p.nameEl.disabled = false; p.nameEl.style.color = 'var(--muted)'; }
          }

          if(animate){ p.correctNumEl.classList.add('num-animate'); setTimeout(()=>p.correctNumEl.classList.remove('num-animate'), 300); }
        });

        undoGlobalBtn.disabled = historyStack.length === 0;
      }

      function escapeHtml(str){ return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

      function ordinalLabel(n){ if(n % 100 >= 11 && n % 100 <= 13) return n + 'th'; const last = n % 10; if(last === 1) return n + 'st'; if(last === 2) return n + 'nd'; if(last === 3) return n + 'rd'; return n + 'th'; }

      function undoGlobal(){
        if(historyStack.length === 0) return;
        const last = historyStack.pop();
        if(!last) return;
        const idx = last.idx;
        const prev = last.prev;
        winners = (last.winners || []).slice();

        if(Array.isArray(last.rights)){
          players.forEach((p, i) => { p.hasRight = !!last.rights[i]; });
        }

        players.forEach((p, i) => { const pos = winners.indexOf(i); p.rank = pos === -1 ? 0 : pos + 1; });

        const target = players[idx];
        target.correct = prev.correct;
        target.wrong = prev.wrong;
        target.rank = prev.rank;
        target.eliminated = prev.eliminated;

        renderAll(true);
      }

      function resetAll(){
        players.forEach((p, i)=>{ p.correct = 0; p.wrong = 0; p.rank = 0; p.eliminated = false; p.hasRight = false; p.nameEl.value = p.nameEl.value || `プレイヤー${i+1}`; p.nameEl.disabled = false; p.nameEl.style.color = 'var(--muted)'; });
        historyStack = []; winners = [];
        renderAll(false);
      }

      function setup(count){
        buildGrid(count); scoreboard.innerHTML = ''; players = []; historyStack = []; winners = [];
        for(let i=0;i<count;i++){ const p = createPlayerColumn(i); players.push(p); scoreboard.appendChild(p.el); }
        players.forEach((p, i)=> { p.nameEl.value = `プレイヤー${i+1}`; p.nameEl.style.color = 'var(--muted)'; });
        renderAll(false);
      }

      // handlers
      setupBtn.addEventListener('click', ()=>{ const c = Math.max(1, Math.min(20, parseInt(playerCountInput.value || 6))); setup(c); });
      resetAllBtn.addEventListener('click', resetAll);
      undoGlobalBtn.addEventListener('click', undoGlobal);
      playerCountInput.addEventListener('input', ()=>{ const c = Math.max(1, Math.min(20, parseInt(playerCountInput.value || 6))); buildGrid(c); });

      // initial
      const initialCount = Math.max(1, Math.min(20, parseInt(playerCountInput.value || 6)));
      setup(initialCount);
    })();
  </script>
</body>
</html>
